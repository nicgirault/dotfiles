{"mode":"editor","version":1,"windowDimensions":{"x":0,"y":49,"width":1920,"height":1031,"maximized":false},"grammars":{"deserializer":"GrammarRegistry","grammarOverridesByPath":{}},"project":{"paths":["/home/nico/projects/bnp-competition-api"],"buffers":[{"text":"from flask import jsonify\n\nfrom services.rank import ranking\nfrom services import portfolio as portfolio_service\nfrom services import championship as championship_service\nfrom clients import serious_game, authenticator\nimport errors\n\n\ndef get_championship_portfolios_and_revisions(championship):\n    # a portfolio is [portfolio_id, name, user_id, team_name]\n    portfolios = portfolio_service.get_portfolios_to_rank(\n        championship_id=championship.id\n    )\n\n    # we need to request authenticator for users nicknames\n    users = authenticator.get_users(\n        ids=[portfolio[2] for portfolio in portfolios]\n    )\n\n    # we aggregate the two results\n    portfolios_data = {\n        str(portfolio[0]): {\n            'name': portfolio[1],\n            'user_nickname': users[portfolio[2]]['nickname'] if users.get(portfolio[2]) else None,\n            'team_name': portfolio[3]\n        } for portfolio in portfolios\n    }\n\n    revisions = serious_game.get_revisions(\n        championship.game_name,\n        [portfolio[0] for portfolio in portfolios],\n        championship.start_date, championship.end_date\n    )\n    return portfolios_data, revisions\n\n\ndef get_game_portfolios_and_revisions(game_name):\n    portfolios = portfolio_service.get_portfolios(\n        game_name=game_name, is_showcase=True\n    )\n    users = authenticator.get_users(\n        ids=[portfolio.user_id for portfolio in portfolios]\n    )\n\n    portfolios_data = {\n        str(portfolio.portfolio_id): {\n            'name': portfolio.name,\n            'user_nickname': users.get(str(portfolio.user_id))['nickname'],\n            'team_name': None\n        } for portfolio in portfolios\n    }\n\n    revisions = serious_game.get_revisions(\n        game_name,\n        [portfolio.portfolio_id for portfolio in portfolios],\n        None, None\n    )\n    return portfolios_data, revisions\n\n\ndef get_ranking(game_name, user):\n    try:\n        championship = championship_service.get_championship(\n            email=user['email'], game_name=game_name\n        )\n    except errors.NoChampionshipAssociated:\n        championship = None\n\n    if championship:\n        portfolios_data, revisions = get_championship_portfolios_and_revisions(championship)\n    else:\n        portfolios_data, revisions = get_game_portfolios_and_revisions(game_name)\n\n    game_data = serious_game.get_game_data(game_name)\n    ranking_data = ranking(\n        revisions,\n        game_data['clp'],\n        game_data['currency'],\n        game_data['safe_fund'],\n        portfolios_data,\n        general_ranking=True if championship else False,\n    )\n\n    return jsonify(ranking=ranking_data)\n","markerStore":{"nextMarkerId":39,"markersById":{"0":{"range":{"start":{"row":50,"column":29},"end":{"row":50,"column":29}},"properties":{"type":"selection","editorId":4,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":{"start":{"row":49,"column":0},"end":{"row":49,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap","maintainHistory":true}},"version":2},"history":{"version":2,"nextCheckpointId":96,"undoStack":[{"type":"checkpoint","id":2,"snapshot":{"0":{"range":[[34,0],[34,0]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[34,0],[34,0]],"newRange":[[34,0],[35,0]],"oldText":"","newText":"\n"}},{"type":"change","content":{"oldRange":[[35,0],[35,0]],"newRange":[[35,0],[35,0]],"oldText":"","newText":""}},{"type":"change","content":{"oldRange":[[35,0],[35,0]],"newRange":[[35,0],[35,1]],"oldText":"","newText":"Ã¹"}},{"type":"checkpoint","id":7,"snapshot":{"0":{"range":[[35,1],[35,1]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":8,"snapshot":{"0":{"range":[[49,75],[49,75]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"1":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[49,75],[49,75]],"newRange":[[49,75],[50,0]],"oldText":"","newText":"\n"}},{"type":"change","content":{"oldRange":[[50,0],[50,0]],"newRange":[[50,0],[50,12]],"oldText":"","newText":"            "}},{"type":"checkpoint","id":11,"snapshot":{"0":{"range":[[50,12],[50,12]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"1":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":12,"snapshot":{"0":{"range":[[50,12],[50,12]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"1":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":13,"snapshot":{"0":{"range":[[50,12],[50,12]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"1":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":14,"snapshot":{"0":{"range":[[50,12],[50,12]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"1":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[50,12],[50,12]],"newRange":[[50,12],[50,14]],"oldText":"","newText":"''"}},{"type":"checkpoint","id":15,"snapshot":{"0":{"range":[[50,14],[50,14]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"1":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":16,"snapshot":{"0":{"range":[[50,13],[50,13]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,13]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"3":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"4":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[50,13],[50,13]],"newRange":[[50,13],[50,14]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[50,14],[50,14]],"newRange":[[50,14],[50,15]],"oldText":"","newText":"v"}},{"type":"change","content":{"oldRange":[[50,15],[50,15]],"newRange":[[50,15],[50,16]],"oldText":"","newText":"a"}},{"type":"checkpoint","id":21,"snapshot":{"0":{"range":[[50,16],[50,16]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,16]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"3":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"4":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":22,"snapshot":{"0":{"range":[[50,16],[50,16]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,16]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"5":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"6":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[50,16],[50,16]],"newRange":[[50,16],[50,17]],"oldText":"","newText":"t"}},{"type":"change","content":{"oldRange":[[50,17],[50,17]],"newRange":[[50,17],[50,18]],"oldText":"","newText":"a"}},{"type":"checkpoint","id":25,"snapshot":{"0":{"range":[[50,18],[50,18]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,18]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"5":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"6":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":26,"snapshot":{"0":{"range":[[50,18],[50,18]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,18]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"7":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"8":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[50,18],[50,18]],"newRange":[[50,18],[50,19]],"oldText":"","newText":"r"}},{"type":"checkpoint","id":27,"snapshot":{"0":{"range":[[50,19],[50,19]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,19]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"7":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"8":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":28,"snapshot":{"0":{"range":[[50,19],[50,19]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,19]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"9":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"10":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[50,13],[50,19]],"newRange":[[50,13],[50,13]],"oldText":"avatar","newText":""}},{"type":"checkpoint","id":31,"snapshot":{"0":{"range":[[50,13],[50,13]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":true,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,13]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"9":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"10":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":32,"snapshot":{"0":{"range":[[50,13],[50,13]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":true,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,13]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"11":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"12":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[50,13],[50,13]],"newRange":[[50,13],[50,14]],"oldText":"","newText":"u"}},{"type":"change","content":{"oldRange":[[50,14],[50,14]],"newRange":[[50,14],[50,15]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[50,15],[50,15]],"newRange":[[50,15],[50,16]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[50,16],[50,16]],"newRange":[[50,16],[50,17]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[50,17],[50,17]],"newRange":[[50,17],[50,18]],"oldText":"","newText":"_"}},{"type":"change","content":{"oldRange":[[50,18],[50,18]],"newRange":[[50,18],[50,19]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[50,19],[50,19]],"newRange":[[50,19],[50,20]],"oldText":"","newText":"v"}},{"type":"change","content":{"oldRange":[[50,20],[50,20]],"newRange":[[50,20],[50,21]],"oldText":"","newText":"a"}},{"type":"checkpoint","id":47,"snapshot":{"0":{"range":[[50,21],[50,21]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":true,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,21]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"11":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"12":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":48,"snapshot":{"0":{"range":[[50,21],[50,21]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":true,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,21]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"14":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"15":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[50,21],[50,21]],"newRange":[[50,21],[50,22]],"oldText":"","newText":"t"}},{"type":"change","content":{"oldRange":[[50,22],[50,22]],"newRange":[[50,22],[50,23]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[50,23],[50,23]],"newRange":[[50,23],[50,24]],"oldText":"","newText":"r"}},{"type":"checkpoint","id":53,"snapshot":{"0":{"range":[[50,24],[50,24]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":true,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"14":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"15":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":54,"snapshot":{"0":{"range":[[50,25],[50,25]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":true,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"16":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"17":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[50,25],[50,25]],"newRange":[[50,25],[50,26]],"oldText":"","newText":":"}},{"type":"checkpoint","id":55,"snapshot":{"0":{"range":[[50,26],[50,26]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":true,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"16":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"17":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":56,"snapshot":{"0":{"range":[[49,29],[49,74]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"18":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"19":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":57,"snapshot":{"0":{"range":[[49,29],[49,74]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"18":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"19":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":58,"snapshot":{"0":{"range":[[50,26],[50,26]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"18":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"19":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[50,26],[50,26]],"newRange":[[50,26],[50,71]],"oldText":"","newText":"users.get(str(portfolio.user_id))['nickname']"}},{"type":"checkpoint","id":61,"snapshot":{"0":{"range":[[50,71],[50,71]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"18":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"19":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"22":{"range":[[50,70],[50,71]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"23":{"range":[[50,59],[50,60]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true}}},{"type":"checkpoint","id":62,"snapshot":{"0":{"range":[[50,26],[50,26]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"24":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"25":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[50,26],[50,26]],"newRange":[[50,26],[50,27]],"oldText":"","newText":" "}},{"type":"checkpoint","id":63,"snapshot":{"0":{"range":[[50,27],[50,27]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"24":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"25":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":64,"snapshot":{"0":{"range":[[50,62],[50,70]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"26":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"27":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[50,62],[50,70]],"newRange":[[50,62],[50,63]],"oldText":"nickname","newText":"a"}},{"type":"change","content":{"oldRange":[[50,63],[50,63]],"newRange":[[50,63],[50,64]],"oldText":"","newText":"v"}},{"type":"change","content":{"oldRange":[[50,64],[50,64]],"newRange":[[50,64],[50,65]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[50,65],[50,65]],"newRange":[[50,65],[50,66]],"oldText":"","newText":"t"}},{"type":"change","content":{"oldRange":[[50,66],[50,66]],"newRange":[[50,66],[50,67]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[50,67],[50,67]],"newRange":[[50,67],[50,68]],"oldText":"","newText":"r"}},{"type":"checkpoint","id":75,"snapshot":{"0":{"range":[[50,68],[50,68]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"26":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"27":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":76,"snapshot":{"0":{"range":[[50,70],[50,70]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"28":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"29":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"32":{"range":[[50,69],[50,70]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"33":{"range":[[50,60],[50,61]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[50,70],[50,70]],"newRange":[[50,70],[50,71]],"oldText":"","newText":","}},{"type":"checkpoint","id":77,"snapshot":{"0":{"range":[[50,71],[50,71]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"28":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"29":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":78,"snapshot":{"0":{"range":[[50,71],[50,71]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"34":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"35":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":79,"snapshot":{"0":{"range":[[50,71],[50,71]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"34":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"35":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":80,"snapshot":{"0":{"range":[[50,71],[50,71]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"34":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"35":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":81,"snapshot":{"0":{"range":[[50,71],[50,71]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"34":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"35":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":82,"snapshot":{"0":{"range":[[50,71],[50,71]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"34":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"35":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":83,"snapshot":{"0":{"range":[[50,71],[50,71]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"34":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"35":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":84,"snapshot":{"0":{"range":[[50,71],[50,71]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,12],[50,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"36":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[34,0],[34,0]],"newRange":[[34,0],[35,0]],"oldText":"","newText":"    return portfolios_data, revisions\n"}},{"type":"change","content":{"oldRange":[[36,0],[37,0]],"newRange":[[36,0],[36,0]],"oldText":"Ã¹    return portfolios_data, revisions\n","newText":""}},{"type":"change","content":{"oldRange":[[37,0],[38,0]],"newRange":[[37,0],[37,0]],"oldText":"\n","newText":""}},{"type":"checkpoint","id":85,"snapshot":{"0":{"range":[[49,71],[49,71]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[49,12],[49,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"36":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":86,"snapshot":{"0":{"range":[[50,29],[50,29]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[49,12],[49,24]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[49,0],[50,0]],"newRange":[[49,0],[49,0]],"oldText":"            'user_avatar': users.get(str(portfolio.user_id))['avatar'],\n","newText":""}},{"type":"checkpoint","id":87,"snapshot":{"0":{"range":[[49,29],[49,29]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[49,0],[49,0]],"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap","maintainHistory":true}}},{"type":"checkpoint","id":88,"snapshot":{"0":{"range":[[50,29],[50,29]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[49,0],[49,0]],"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[49,0],[49,0]],"newRange":[[49,0],[50,0]],"oldText":"","newText":"            'user_avatar': users.get(str(portfolio.user_id))['avatar'],\n"}},{"type":"checkpoint","id":89,"snapshot":{"0":{"range":[[51,29],[51,29]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[49,0],[50,0]],"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap","maintainHistory":true}}},{"type":"checkpoint","id":90,"snapshot":{"0":{"range":[[50,29],[50,29]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[49,0],[50,0]],"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[34,0],[35,0]],"newRange":[[34,0],[34,0]],"oldText":"    return portfolios_data, revisions\n","newText":""}},{"type":"change","content":{"oldRange":[[35,0],[35,0]],"newRange":[[35,0],[36,0]],"oldText":"","newText":"Ã¹    return portfolios_data, revisions\n"}},{"type":"change","content":{"oldRange":[[37,0],[37,0]],"newRange":[[37,0],[38,0]],"oldText":"","newText":"\n"}},{"type":"checkpoint","id":91,"snapshot":{"0":{"range":[[51,29],[51,29]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap","maintainHistory":true}}},{"type":"checkpoint","id":92,"snapshot":{"0":{"range":[[50,29],[50,29]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[50,0],[51,0]],"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap","maintainHistory":true},"38":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[34,0],[34,0]],"newRange":[[34,0],[35,0]],"oldText":"","newText":"    return portfolios_data, revisions\n"}},{"type":"change","content":{"oldRange":[[36,0],[37,0]],"newRange":[[36,0],[36,0]],"oldText":"Ã¹    return portfolios_data, revisions\n","newText":""}},{"type":"change","content":{"oldRange":[[37,0],[38,0]],"newRange":[[37,0],[37,0]],"oldText":"\n","newText":""}},{"type":"checkpoint","id":93,"snapshot":{"0":{"range":[[49,29],[49,29]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[49,0],[50,0]],"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap","maintainHistory":true},"38":{"range":[[34,0],[36,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":94,"snapshot":{"0":{"range":[[50,29],[50,29]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[49,0],[50,0]],"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[49,0],[50,0]],"newRange":[[49,0],[49,0]],"oldText":"            'user_avatar': users.get(str(portfolio.user_id))['avatar'],\n","newText":""}},{"type":"checkpoint","id":95,"snapshot":{"0":{"range":[[49,29],[49,29]],"properties":{"type":"selection","editorId":4,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[49,0],[49,0]],"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap","maintainHistory":true}}}],"redoStack":[]},"encoding":"utf8","filePath":"/home/nico/projects/bnp-competition-api/src/services/ranking.py","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"ff2f8ec4e7b4ee4673763de07297dd8c6c80d845","deserializer":"TextBuffer","version":2},{"text":"import json\nfrom flask import Blueprint, Response\nfrom flask.ext.restful.reqparse import Argument\nfrom validate_request import parse\n\nfrom services.rank import ranking\nfrom services import ranking as ranking_service\nfrom decorators import catch_exceptions, required_authentication\n\nranking_blueprint = Blueprint('ranking', __name__)\n\n\n@ranking_blueprint.route('/ranking', methods=['POST'])\ndef compute_ranking():\n    arguments = [\n        Argument('revisions', type=list, help='revisions is required and must be a list', required=True, location='json'),\n        Argument('clp', type=str, help='clp is required', required=True, location='json'),\n        Argument('currency', type=str, help='currency is required', required=True, location='json'),\n        Argument('safeFundAnnualRates', type=dict, help='safeFundAnnualRates must be {\"year\": rate, ...}', location='json'),\n    ]\n    args = parse(arguments)\n\n    ranking_data = ranking(args.revisions, args.clp, args.currency, args.safeFundAnnualRates)\n    return Response(\n        json.dumps(ranking_data),\n        headers={'Cache-Control': 'no-cache'},\n        mimetype='application/json',\n    )\n\n\n@ranking_blueprint.route('/game/<game_name>/ranking', methods=['GET'])\n@catch_exceptions\n@required_authentication\ndef get_ranking(game_name, league_id=None, user=None):\n    return ranking_service.get_ranking(game_name, user=user)\n","markerStore":{"nextMarkerId":1,"markersById":{"0":{"range":{"start":{"row":12,"column":18},"end":{"row":12,"column":18}},"properties":{"type":"selection","editorId":8,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}},"version":2},"history":{"version":2,"nextCheckpointId":2,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/nico/projects/bnp-competition-api/src/routes/ranking.py","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"e73efe06582c79af33f3bfabdae2ebd3593f28b3","deserializer":"TextBuffer","version":2},{"text":"from flask import Blueprint\nfrom flask import jsonify\nfrom flask.ext.restful.reqparse import Argument\n\nfrom decorators import catch_exceptions, required_authentication, required_admin\nfrom services import league, championship as championship_service, team\nfrom services import portfolio as portfolio_service\nfrom validate_request import parse\nfrom models import db\nfrom clients import serious_game\n\nadmin_blueprint = Blueprint('admin', __name__)\n\n\n@admin_blueprint.route('/admin/game/<game_name>/league', methods=['GET'])\n@catch_exceptions\ndef get_league_ranking(game_name):\n    return league.get_leagues(game_name)\n\n\n@admin_blueprint.route('/admin/game/<game_name>/championship', methods=['GET'])\n@catch_exceptions\ndef get_championships(game_name):\n    return championship_service.get_championships(game_name)\n\n\n@admin_blueprint.route('/admin/championship/<championship_id>', methods=['GET'])\n@catch_exceptions\n@required_authentication\n@required_admin\ndef get_championship(championship_id, user):\n    return jsonify(championship=championship_service.get_championship(championship_id).to_json())\n\n\n@admin_blueprint.route('/admin/championship/<championship_id>/team', methods=['POST'])\n@catch_exceptions\n@required_authentication\n@required_admin\ndef add_captains(championship_id, user):\n    arguments = [\n        Argument('captainEmails', type=list, help='captainEmails must be a list', location='json', required=True),\n    ]\n    args = parse(arguments)\n\n    championship = championship_service.get_championship(championship_id)\n\n    for email in args.captainEmails:\n        team.add_captain(championship, email)\n\n    return jsonify(championship=championship.to_json())\n\n\n@admin_blueprint.route('/game/<game_name>/user', methods=['GET'])\n@catch_exceptions\n@required_authentication\n@required_admin\ndef get_game_users(game_name, user):\n    return jsonify(users=portfolio_service.get_users(game_name))\n\n\n@admin_blueprint.route('/game/<game_name>/user/<user_id>/portfolio', methods=['GET'])\n@catch_exceptions\n@required_authentication\n@required_admin\ndef get_portfolios(game_name, user_id, user):\n    portfolios = portfolio_service.get_portfolios(game_name=game_name, user_id=user_id)\n    return jsonify(portfolios=[portfolio.to_json() for portfolio in portfolios])\n\n\n@admin_blueprint.route('/admin/game/<game_name>/portfolio', methods=['DELETE'])\n@catch_exceptions\n@required_authentication\n@required_admin\ndef delete_portfolios(game_name, user):\n    arguments = [\n        Argument('portfolio_id', type=int, help='portfolio_id key is required and must be an integer', required=True),\n    ]\n    args = parse(arguments)\n\n    portfolio = portfolio_service.get_portfolio(\n        portfolio_id=args.portfolio_id,\n    )\n    serious_game.delete_portfolio(game_name, args.portfolio_id)\n    db.session.delete(portfolio)\n    db.session.commit()\n    return 'OK', 200\n","markerStore":{"nextMarkerId":1,"markersById":{"0":{"range":{"start":{"row":30,"column":38},"end":{"row":30,"column":42}},"properties":{"type":"selection","editorId":12,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}},"version":2},"history":{"version":2,"nextCheckpointId":8,"undoStack":[{"type":"checkpoint","id":2,"snapshot":{"0":{"range":[[29,0],[29,15]],"properties":{"type":"selection","editorId":12,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":3,"snapshot":{"0":{"range":[[29,0],[29,15]],"properties":{"type":"selection","editorId":12,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":4,"snapshot":{"0":{"range":[[28,0],[28,24]],"properties":{"type":"selection","editorId":12,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":5,"snapshot":{"0":{"range":[[28,0],[28,24]],"properties":{"type":"selection","editorId":12,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":6,"snapshot":{"0":{"range":[[30,38],[30,42]],"properties":{"type":"selection","editorId":12,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":7,"snapshot":{"0":{"range":[[30,38],[30,42]],"properties":{"type":"selection","editorId":12,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}}],"redoStack":[]},"encoding":"utf8","filePath":"/home/nico/projects/bnp-competition-api/src/routes/admin.py","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"88a64b75ad0bc4d686ef20f7f099290c4c635102","deserializer":"TextBuffer","version":2},{"text":"from services import indicators\nimport pandas as pd\n\n\ndef group_revisions(revisions):\n    revisions_df = pd.DataFrame(\n        revisions,\n        index=[pd.Timestamp(revision['valuation_date']) for revision in revisions]\n    ).sort_index()\n    return {\n        'general': revisions_df,\n        'monthly': revisions_df.groupby(pd.TimeGrouper(freq='M')),\n        'quarterly': revisions_df.groupby(pd.TimeGrouper(freq='Q'))\n    }\n\n\ndef ranking(revisions, clp, currency, safeFundsRates, portfolios_data=None, general_ranking=False):\n    if len(revisions) == 0:\n        return None\n    grouped_revisions = group_revisions(revisions)\n\n    ranking = {\n        'by_month': [\n            {\n                'period': str(month.to_period()),\n                'portfolios': compute_ranking_indicators(revisions_df, clp, currency, safeFundsRates, portfolios_data),\n            } for month, revisions_df in grouped_revisions['monthly']\n        ],\n        'by_quarter': [\n            {\n                'period': str(month.to_period()),\n                'portfolios': compute_ranking_indicators(revisions_df, clp, currency, safeFundsRates, portfolios_data),\n            } for month, revisions_df in grouped_revisions['quarterly']\n        ],\n    }\n    if general_ranking:\n        ranking['general'] = [\n            {\n                'period': 'general',\n                'portfolios': compute_ranking_indicators(grouped_revisions['general'], clp, currency, safeFundsRates, portfolios_data),\n            }\n        ]\n    return ranking\n\n\ndef compute_ranking_indicators(revisions_df, clp, currency, safeFundsRates, portfolios_data):\n    portfolios = []\n    grouped_revisions = revisions_df.groupby('portfolio_id')\n\n    for id, portfolio_revisions_df in grouped_revisions:\n        portfolio_revisions_df = portfolio_revisions_df.sort('valuation_date')\n        id = str(id)\n        portfolio = {\n            'id': id,\n            'performance': indicators.compute_performance(portfolio_revisions_df['amount']),\n            'volatility': None,\n            'value_at_risk': None,\n            'performance_over_volatility': None,\n            'performance_over_value_at_risk': None\n        }\n        if portfolios_data is not None:\n            portfolio['name'] = portfolios_data[id]['name']\n            portfolio['user_nickname'] = portfolios_data[id]['user_nickname']\n            portfolio['team_name'] = portfolios_data[id]['team_name']\n\n        if portfolio['performance'] is not None:\n            portfolio['volatility'] = indicators.compute_volatility(portfolio_revisions_df, clp, currency, safeFundsRates)\n\n            if portfolio['volatility'] is not None and abs(portfolio['volatility']) > 0.00000001:\n                portfolio['value_at_risk'] = indicators.compute_value_at_risk(portfolio['volatility'])\n                portfolio['performance_over_volatility'] = portfolio['performance'] / portfolio['volatility']\n\n            if portfolio['value_at_risk'] is not None and abs(portfolio['value_at_risk']) > 0.00000001:\n                portfolio['performance_over_value_at_risk'] = portfolio['performance'] / portfolio['value_at_risk']\n\n        portfolios.append(portfolio)\n\n    return portfolios\n","markerStore":{"nextMarkerId":20,"markersById":{"0":{"range":{"start":{"row":63,"column":69},"end":{"row":63,"column":69}},"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"18":{"range":{"start":{"row":63,"column":68},"end":{"row":63,"column":69}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"19":{"range":{"start":{"row":63,"column":56},"end":{"row":63,"column":57}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true}},"version":2},"history":{"version":2,"nextCheckpointId":88,"undoStack":[{"type":"checkpoint","id":2,"snapshot":{"0":{"range":[[62,26],[62,26]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[62,0],[62,0]],"newRange":[[62,0],[63,0]],"oldText":"","newText":"            portfolio['user_nickname'] = portfolios_data[id]['user_nickname']\n"}},{"type":"checkpoint","id":7,"snapshot":{"0":{"range":[[63,26],[63,26]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":8,"snapshot":{"0":{"range":[[63,36],[63,36]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"1":{"range":[[63,0],[64,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[63,35],[63,36]],"newRange":[[63,35],[63,35]],"oldText":"e","newText":""}},{"type":"change","content":{"oldRange":[[63,34],[63,35]],"newRange":[[63,34],[63,34]],"oldText":"m","newText":""}},{"type":"change","content":{"oldRange":[[63,33],[63,34]],"newRange":[[63,33],[63,33]],"oldText":"a","newText":""}},{"type":"change","content":{"oldRange":[[63,32],[63,33]],"newRange":[[63,32],[63,32]],"oldText":"n","newText":""}},{"type":"change","content":{"oldRange":[[63,31],[63,32]],"newRange":[[63,31],[63,31]],"oldText":"k","newText":""}},{"type":"change","content":{"oldRange":[[63,30],[63,31]],"newRange":[[63,30],[63,30]],"oldText":"c","newText":""}},{"type":"change","content":{"oldRange":[[63,29],[63,30]],"newRange":[[63,29],[63,29]],"oldText":"i","newText":""}},{"type":"change","content":{"oldRange":[[63,28],[63,29]],"newRange":[[63,28],[63,28]],"oldText":"n","newText":""}},{"type":"checkpoint","id":39,"snapshot":{"0":{"range":[[63,28],[63,28]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":true,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"1":{"range":[[63,0],[64,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":40,"snapshot":{"0":{"range":[[63,28],[63,28]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":true,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"1":{"range":[[63,0],[64,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[63,28],[63,28]],"newRange":[[63,28],[63,29]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[63,29],[63,29]],"newRange":[[63,29],[63,30]],"oldText":"","newText":"v"}},{"type":"change","content":{"oldRange":[[63,30],[63,30]],"newRange":[[63,30],[63,31]],"oldText":"","newText":"a"}},{"type":"checkpoint","id":45,"snapshot":{"0":{"range":[[63,31],[63,31]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":true,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"1":{"range":[[63,0],[64,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[63,23],[63,23]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true}}},{"type":"checkpoint","id":46,"snapshot":{"0":{"range":[[63,31],[63,31]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":true,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[63,23],[63,23]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"3":{"range":[[63,0],[64,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[63,31],[63,31]],"newRange":[[63,31],[63,32]],"oldText":"","newText":"t"}},{"type":"change","content":{"oldRange":[[63,32],[63,32]],"newRange":[[63,32],[63,33]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[63,33],[63,33]],"newRange":[[63,33],[63,34]],"oldText":"","newText":"r"}},{"type":"checkpoint","id":51,"snapshot":{"0":{"range":[[63,34],[63,34]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":true,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"2":{"range":[[63,23],[63,23]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"3":{"range":[[63,0],[64,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":52,"snapshot":{"0":{"range":[[62,23],[62,36]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"4":{"range":[[63,0],[64,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[63,0],[63,0]],"newRange":[[63,0],[64,0]],"oldText":"","newText":"            portfolio['user_nickname'] = portfolios_data[id]['user_nickname']\n"}},{"type":"checkpoint","id":55,"snapshot":{"0":{"range":[[63,23],[63,36]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"4":{"range":[[63,0],[65,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":56,"snapshot":{"0":{"range":[[63,23],[63,36]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"5":{"range":[[63,0],[65,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[64,0],[64,0]],"newRange":[[64,0],[65,0]],"oldText":"","newText":"            portfolio['user_nickname'] = portfolios_data[id]['user_nickname']\n"}},{"type":"checkpoint","id":59,"snapshot":{"0":{"range":[[64,23],[64,36]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"5":{"range":[[63,0],[66,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":60,"snapshot":{"0":{"range":[[63,32],[63,32]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"6":{"range":[[63,0],[66,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[63,0],[64,0]],"newRange":[[63,0],[63,0]],"oldText":"            portfolio['user_nickname'] = portfolios_data[id]['user_nickname']\n","newText":""}},{"type":"checkpoint","id":63,"snapshot":{"0":{"range":[[63,0],[63,0]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"6":{"range":[[63,0],[65,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":64,"snapshot":{"0":{"range":[[63,0],[63,0]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"7":{"range":[[63,0],[65,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[63,0],[64,0]],"newRange":[[63,0],[63,0]],"oldText":"            portfolio['user_nickname'] = portfolios_data[id]['user_nickname']\n","newText":""}},{"type":"checkpoint","id":67,"snapshot":{"0":{"range":[[63,0],[63,0]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"7":{"range":[[63,0],[64,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":68,"snapshot":{"0":{"range":[[63,65],[63,73]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"8":{"range":[[63,0],[64,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[63,65],[63,73]],"newRange":[[63,65],[63,66]],"oldText":"nickname","newText":"a"}},{"type":"change","content":{"oldRange":[[63,66],[63,66]],"newRange":[[63,66],[63,67]],"oldText":"","newText":"v"}},{"type":"change","content":{"oldRange":[[63,67],[63,67]],"newRange":[[63,67],[63,68]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[63,68],[63,68]],"newRange":[[63,68],[63,69]],"oldText":"","newText":"t"}},{"type":"change","content":{"oldRange":[[63,69],[63,69]],"newRange":[[63,69],[63,70]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[63,70],[63,70]],"newRange":[[63,70],[63,71]],"oldText":"","newText":"r"}},{"type":"checkpoint","id":79,"snapshot":{"0":{"range":[[63,71],[63,71]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"8":{"range":[[63,0],[64,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true},"9":{"range":[[63,60],[63,60]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true}}},{"type":"checkpoint","id":80,"snapshot":{"0":{"range":[[63,71],[63,71]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"9":{"range":[[63,60],[63,60]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"10":{"range":[[63,0],[64,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":81,"snapshot":{"0":{"range":[[63,71],[63,71]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"9":{"range":[[63,60],[63,60]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"10":{"range":[[63,0],[64,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":82,"snapshot":{"0":{"range":[[63,71],[63,71]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"10":{"range":[[63,0],[64,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[63,0],[64,0]],"newRange":[[63,0],[63,0]],"oldText":"            portfolio['user_avatar'] = portfolios_data[id]['user_avatar']\n","newText":""}},{"type":"checkpoint","id":83,"snapshot":{"0":{"range":[[63,0],[63,0]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"10":{"range":[[63,0],[63,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":84,"snapshot":{"0":{"range":[[63,69],[63,69]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"11":{"range":[[63,68],[63,69]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"12":{"range":[[63,56],[63,57]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[63,0],[63,0]],"newRange":[[63,0],[64,0]],"oldText":"","newText":"            portfolio['user_avatar'] = portfolios_data[id]['user_avatar']\n"}},{"type":"checkpoint","id":85,"snapshot":{"0":{"range":[[64,69],[64,69]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":86,"snapshot":{"0":{"range":[[63,69],[63,69]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[63,0],[64,0]],"newRange":[[63,0],[63,0]],"oldText":"            portfolio['user_avatar'] = portfolios_data[id]['user_avatar']\n","newText":""}},{"type":"checkpoint","id":87,"snapshot":{"0":{"range":[[63,0],[63,0]],"properties":{"type":"selection","editorId":16,"goalScreenRange":null,"autoscroll":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true}}}],"redoStack":[]},"encoding":"utf8","filePath":"/home/nico/projects/bnp-competition-api/src/services/rank.py","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"9ae7eff0dd17028db75c47daed75f267b5b95e47","deserializer":"TextBuffer","version":2},{"text":"import json, config\nfrom test.functional.resources.AuthenticatedTestCase import AuthenticatedTestCase\n\nimport requests\n\n\nclass TestTeam(AuthenticatedTestCase):\n    url_team_member = config.COMPETITION_URL + \"/game/yolo/championship/team/member\"\n    url_team_name = config.COMPETITION_URL + \"/game/yolo/championship/team/name\"\n    member_emails = ['unittesttoto@toto.toto', 'unittesttata@tata.tata']\n\n    def test_post_add_user(self):\n        auth_headers = {\n            'Content-Type': 'application/json',\n            'Authorization': self.authenticate('captain@theo.do')\n        }\n\n        response = requests.post(\n            self.url_team_member,\n            data=json.dumps({\n                'memberEmails': self.member_emails,\n            }),\n            headers=auth_headers\n        )\n        self.assertEqual(response.status_code, 200)\n\n        response = requests.post(\n            self.url_team_member,\n            headers=auth_headers\n        )\n        self.assertEqual(response.status_code, 400)\n\n    def test_it_returns_an_error_when_host_is_not_captain(self):\n        auth_headers = {\n            'Content-Type': 'application/json',\n            'Authorization': self.authenticate('member@theo.do')\n        }\n        response = requests.post(\n            self.url_team_member,\n            data=json.dumps({\n                'memberEmails': ['dummy@theo.do'],\n            }),\n            headers=auth_headers\n        )\n\n        error = json.loads(response.text)\n        self.assertEqual(response.status_code, 401)\n        self.assertEqual(error['key'], 'ACTION_RESERVED_TO_CAPTAIN')\n\n    def test_mailer_is_called(self):\n        auth_headers = {\n            'Content-Type': 'application/json',\n            'Authorization': self.authenticate('captain@theo.do')\n        }\n        response = requests.post(\n            self.url_team_member,\n            data=json.dumps({\n                'memberEmails': ['dummy1@theo.do'],\n            }),\n            headers=auth_headers\n        )\n        self.assertEqual(response.status_code, 200)\n\n    def test_post_edit_team_name(self):\n        auth_headers = {\n            'Content-Type': 'application/json',\n            'Authorization': self.authenticate('captain@theo.do')\n        }\n\n        response = requests.post(\n            self.url_team_name,\n            data=json.dumps({\n                'teamName': 'unittest',\n            }),\n            headers=auth_headers\n        )\n        self.assertEqual(response.status_code, 200)\n\n        response = requests.post(\n            self.url_team_name,\n            headers=auth_headers\n        )\n        self.assertEqual(response.status_code, 400)","markerStore":{"nextMarkerId":1,"markersById":{"0":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","editorId":20},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true}},"version":2},"history":{"version":2,"nextCheckpointId":2,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/nico/projects/bnp-competition-api/test/functional/services/testTeam.py","modifiedWhenLastPersisted":true,"digestWhenLastPersisted":"da39a3ee5e6b4b0d3255bfef95601890afd80709","deserializer":"TextBuffer","version":2},{"text":"import os\nimport tempfile\nimport json\nimport unittest\nfrom mock import patch\n\nimport config\nfrom datetime import date, timedelta\nfrom server import create_app\nfrom models import db, Championship, Team, TeamMember\nfrom mocks import authenticator_mock\n\n\nclass TestTeam(unittest.TestCase):\n\n    def setUp(self):\n        self.db_fd, self.path = tempfile.mkstemp()\n        config.POSTGRES_URI = 'sqlite:///' + self.path\n\n        app = create_app()\n        app.config['TESTING'] = True\n        self.client = app.test_client()\n\n        db.create_all()\n\n        championship1 = Championship('championship 1',\n            date.today() + timedelta(days=2),\n            date.today() + timedelta(days=4),\n            20000, 'gameA'\n        )\n        db.session.add(championship1)\n        db.session.commit()\n\n        self.team1 = Team(championship1.id, 'Team A')\n        db.session.add(self.team1)\n        db.session.commit()\n\n        captain = TeamMember(self.team1.id, 'captain@theodo.fr', True)\n        db.session.add(captain)\n        db.session.commit()\n\n        self.patcher1 = patch('clients.authenticator.get_users')\n        get_users = self.patcher1.start()\n        get_users.side_effect = authenticator_mock.get_users_mock\n\n        self.patcher2 = patch('clients.mailer.send_mail')\n        self.send_mail = self.patcher2.start()\n\n        self.headers = {'Content-Type': 'application/json'}\n\n    def tearDown(self):\n        db.session.remove()\n        db.drop_all()\n        os.close(self.db_fd)\n        os.unlink(self.path)\n        self.patcher1.stop()\n        self.patcher2.stop()\n\n    def test_add_members_to_teams(self):\n        patcher = patch('clients.authenticator.me')\n        me = patcher.start()\n        me.return_value = authenticator_mock.me_as('captain@theodo.fr')\n\n        response = self.client.post(\n            '/competition/team/'+str(self.team1.id)+'/member',\n            data=json.dumps({\n                'memberEmails': ['member1@theodo.fr', 'member2@theodo.fr'],\n            }),\n            headers=self.headers\n        )\n        self.assertEqual(response.status_code, 200)\n\n        response = self.client.post(\n            '/competition/team/'+str(self.team1.id)+'/member',\n        )\n        self.assertEqual(response.status_code, 400)\n\n        patcher.stop()\n\n    def test_it_returns_an_error_when_host_is_not_captain(self):\n        patcher = patch('clients.authenticator.me')\n        me = patcher.start()\n        me.return_value = authenticator_mock.me_as('not_captain@theodo.fr')\n\n        response = self.client.post(\n            '/competition/team/'+str(self.team1.id)+'/member',\n            data=json.dumps({\n                'memberEmails': ['member1@theodo.fr', 'member2@theodo.fr'],\n            }),\n            headers=self.headers\n        )\n\n        error = json.loads(response.data.decode('utf-8'))\n        self.assertEqual(response.status_code, 401)\n        self.assertEqual(error['key'], 'ACTION_RESERVED_TO_CAPTAIN')\n\n    def test_mailer_is_called(self):\n        patcher = patch('clients.authenticator.me')\n        me = patcher.start()\n        me.return_value = authenticator_mock.me_as('captain@theodo.fr')\n\n        response = self.client.post(\n            '/competition/team/'+str(self.team1.id)+'/member',\n            data=json.dumps({\n                'memberEmails': ['member1@theodo.fr', 'member2@theodo.fr'],\n            }),\n            headers=self.headers\n        )\n\n        self.assertEqual(response.status_code, 200)\n        self.assertEqual(self.send_mail.call_count, 2)\n\n    def test_post_edit_team_name(self):\n        patcher = patch('clients.authenticator.me')\n        me = patcher.start()\n        me.return_value = authenticator_mock.me_as('captain@theodo.fr')\n\n        response = self.client.patch(\n            '/competition/team/'+str(self.team1.id),\n            data=json.dumps({\n                'name': 'unittest',\n            }),\n            headers=self.headers\n        )\n        result = json.loads(response.data.decode('utf-8'))\n        self.assertEqual(response.status_code, 200)\n        self.assertEqual(result['team']['name'], 'unittest')\n","markerStore":{"nextMarkerId":1,"markersById":{"0":{"range":{"start":{"row":48,"column":8},"end":{"row":48,"column":59}},"properties":{"type":"selection","editorId":24,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}},"version":2},"history":{"version":2,"nextCheckpointId":6,"undoStack":[{"type":"checkpoint","id":2,"snapshot":{"0":{"range":[[124,8],[124,58]],"properties":{"type":"selection","editorId":24,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":3,"snapshot":{"0":{"range":[[124,8],[124,58]],"properties":{"type":"selection","editorId":24,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":4,"snapshot":{"0":{"range":[[48,8],[48,59]],"properties":{"type":"selection","editorId":24,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":5,"snapshot":{"0":{"range":[[48,8],[48,59]],"properties":{"type":"selection","editorId":24,"goalScreenRange":null},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}}],"redoStack":[]},"encoding":"utf8","filePath":"/home/nico/projects/bnp-competition-api/test/functional/services/test_team.py","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"8855665f3806f93a6aa6a46e71abe2797cd336df","deserializer":"TextBuffer","version":2},{"text":"from flask import Blueprint, jsonify\nfrom flask.ext.restful import Api\nfrom flask.ext.restful.reqparse import Argument\n\nfrom decorators import catch_exceptions, required_authentication\nfrom services import team as team_service, portfolio as portfolio_service, email as email_service\nimport errors\nfrom validate_request import parse\n\nteam_blueprint = Blueprint('team', __name__)\nteam_blueprint_api = Api(team_blueprint)\n\nfrom resources.team import TeamResource\nteam_blueprint_api.add_resource(\n    TeamResource,\n    '/team/<team_id>'\n)\n\n\n@team_blueprint.route('/team/<team_id>/member', methods=['POST'])\n@catch_exceptions\n@required_authentication\ndef create_new_team_member(team_id, user):\n    host_email = user['email'].lower()\n    if team_service.is_captain(team_id, host_email) is True:\n        arguments = [\n            Argument('memberEmails', type=list, help='memberEmails is required and must be a list of emails', location='json', required=True),\n        ]\n\n        args = parse(arguments)\n        emails = email_service.parse_emails(args.memberEmails)\n\n        team_service.add_team_members(team_id, emails)\n        updated_team = team_service.get_team(team_id)\n\n        return jsonify(team=updated_team.to_json())\n    else:\n        raise errors.ActionReservedToTeamCaptain()\n\n\n@team_blueprint.route('/game/<game_name>/member/activate', methods=['PUT'])\n@catch_exceptions\n@required_authentication\ndef update_user_status(game_name, user):\n    team_service.activate(game_name, user['email'], user['id'])\n    return 'OK'\n\n\n@team_blueprint.route('/game/<game_name>/member/decline', methods=['DELETE'])\n@catch_exceptions\n@required_authentication\ndef delete_member(game_name, user):\n    team_service.decline(game_name, user['email'])\n    return 'OK'\n\n\n@team_blueprint.route('/game/<game_name>/my-status', methods=['GET'])\n@catch_exceptions\n@required_authentication\ndef get_status(game_name, user):\n    return team_service.validate_captain_status(game_name, user)\n","markerStore":{"nextMarkerId":1,"markersById":{"0":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","editorId":28},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true}},"version":2},"history":{"version":2,"nextCheckpointId":2,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/nico/projects/bnp-competition-api/src/routes/team.py","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"7e35a57dbbf6d1f3f5e4ce6270a03d0f35a3cdf4","deserializer":"TextBuffer","version":2}],"deserializer":"Project"},"workspace":{"paneContainer":{"root":{"id":3,"items":[{"id":4,"softTabs":true,"displayBuffer":{"id":5,"softWrapped":true,"scrollTop":1440,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"/home/nico/projects/bnp-competition-api/src/services/ranking.py","largeFileMode":false,"deserializer":"TokenizedBuffer"},"largeFileMode":false,"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"},{"id":16,"softTabs":true,"displayBuffer":{"id":17,"softWrapped":true,"scrollTop":1286,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"/home/nico/projects/bnp-competition-api/src/services/rank.py","largeFileMode":false,"deserializer":"TokenizedBuffer"},"largeFileMode":false,"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"},{"id":20,"softTabs":true,"displayBuffer":{"id":21,"softWrapped":true,"scrollTop":144,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"/home/nico/projects/bnp-competition-api/test/functional/services/testTeam.py","largeFileMode":false,"deserializer":"TokenizedBuffer"},"largeFileMode":false,"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"},{"id":24,"softTabs":true,"displayBuffer":{"id":25,"softWrapped":true,"scrollTop":995,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"/home/nico/projects/bnp-competition-api/test/functional/services/test_team.py","largeFileMode":false,"deserializer":"TokenizedBuffer"},"largeFileMode":false,"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"},{"id":28,"softTabs":true,"displayBuffer":{"id":29,"softWrapped":true,"scrollTop":1154,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"/home/nico/projects/bnp-competition-api/src/routes/team.py","largeFileMode":false,"deserializer":"TokenizedBuffer"},"largeFileMode":false,"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"},{"id":12,"softTabs":true,"displayBuffer":{"id":13,"softWrapped":true,"scrollTop":96,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"/home/nico/projects/bnp-competition-api/src/routes/admin.py","largeFileMode":false,"deserializer":"TokenizedBuffer"},"largeFileMode":false,"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"},{"id":8,"softTabs":true,"displayBuffer":{"id":9,"softWrapped":true,"scrollTop":83,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"/home/nico/projects/bnp-competition-api/src/routes/ranking.py","largeFileMode":false,"deserializer":"TokenizedBuffer"},"largeFileMode":false,"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"}],"activeItemURI":"/home/nico/projects/bnp-competition-api/test/functional/services/test_team.py","focused":true,"flexScale":1,"deserializer":"Pane"},"activePaneId":3,"deserializer":"PaneContainer","version":1},"fullScreen":false,"packagesWithActiveGrammars":["language-python","language-sql","language-hyperlink","language-todo"],"deserializer":"Workspace"},"packageStates":{"fuzzy-finder":{"/home/nico/projects/bnp-competition-api/src/services/ranking.py":1435583763754,"/home/nico/projects/bnp-competition-api/src/services/rank.py":1435583770518,"/home/nico/projects/bnp-competition-api/test/functional/services/testTeam.py":1435586623070,"/home/nico/projects/bnp-competition-api/test/functional/services/test_team.py":1435588798111,"/home/nico/projects/bnp-competition-api/src/routes/team.py":1435588759818,"/home/nico/projects/bnp-competition-api/src/routes/admin.py":1435583274544,"/home/nico/projects/bnp-competition-api/src/routes/ranking.py":1435582291781},"metrics":{"sessionLength":8083749},"tabs":[{}],"tree-view":{"directoryExpansionStates":{"/home/nico/projects/bnp-competition-api":{"isExpanded":true,"entries":{".git":{"isExpanded":false,"entries":{}},"doc":{"isExpanded":false,"entries":{}},"migrations":{"isExpanded":false,"entries":{}},"src":{"isExpanded":true,"entries":{"commands":{"isExpanded":false,"entries":{}},"models":{"isExpanded":false,"entries":{}},"resources":{"isExpanded":false,"entries":{}},"routes":{"isExpanded":true,"entries":{}},"services":{"isExpanded":true,"entries":{}}}},"test":{"isExpanded":true,"entries":{"fixtures":{"isExpanded":false,"entries":{}},"functional":{"isExpanded":true,"entries":{"resources":{"isExpanded":false,"entries":{}},"services":{"isExpanded":true,"entries":{}}}},"unit":{"isExpanded":false,"entries":{}},"mocks":{"isExpanded":false,"entries":{}}}},"utils":{"isExpanded":false,"entries":{}}}}},"selectedPath":"/home/nico/projects/bnp-competition-api/test/functional/services/test_team.py","hasFocus":false,"attached":true,"scrollLeft":0,"scrollTop":0,"width":200}}}